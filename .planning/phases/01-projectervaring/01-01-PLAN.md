---
phase: 01-projectervaring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/app/api/folders/route.ts
  - src/app/api/folders/[id]/route.ts
  - src/app/api/projects/route.ts
  - src/app/api/projects/[id]/route.ts
  - src/app/(dashboard)/projects/page.tsx
  - src/components/FolderItem.tsx
  - src/components/ProjectCard.tsx
  - src/hooks/useContextMenu.ts
  - src/components/ContextMenu.tsx
autonomous: true
requirements:
  - ORG-01
  - ORG-02
  - ORG-03

must_haves:
  truths:
    - "Gebruiker kan een map aanmaken via '+ Nieuwe map' knop en deze verschijnt in de projectenlijst"
    - "Gebruiker kan een map hernoemen en verwijderen via rechtermuisklik contextmenu"
    - "Bij verwijderen van een map worden projecten erin losse projecten (terug naar root)"
    - "Gebruiker kan een project naar een map slepen (drag-and-drop) en het verschijnt in die map"
    - "Gebruiker kan een project uit een map terug naar root slepen"
    - "Mappen staan bovenaan de projectenlijst, losse projecten eronder"
    - "Mappen zijn uitklapbaar en tonen hun projecten eronder"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Folder model with userId, onDelete:SetNull on Project.folderId"
      contains: "model Folder"
    - path: "src/app/api/folders/route.ts"
      provides: "GET list + POST create folder endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/folders/[id]/route.ts"
      provides: "PATCH rename + DELETE folder endpoints"
      exports: ["PATCH", "DELETE"]
    - path: "src/app/(dashboard)/projects/page.tsx"
      provides: "Projects list page with folders, drag-and-drop, context menu"
      min_lines: 80
    - path: "src/components/FolderItem.tsx"
      provides: "Collapsible folder component with droppable zone"
      min_lines: 30
    - path: "src/components/ProjectCard.tsx"
      provides: "Draggable project card (name, badge, date)"
      min_lines: 20
  key_links:
    - from: "src/app/(dashboard)/projects/page.tsx"
      to: "/api/folders"
      via: "fetch in useEffect"
      pattern: "fetch.*api/folders"
    - from: "src/app/(dashboard)/projects/page.tsx"
      to: "@dnd-kit/core DndContext"
      via: "DndContext wrapping folder/project list"
      pattern: "DndContext"
    - from: "src/components/FolderItem.tsx"
      to: "@dnd-kit/core useDroppable"
      via: "useDroppable hook for folder drop target"
      pattern: "useDroppable"
    - from: "src/components/ProjectCard.tsx"
      to: "@dnd-kit/core useDraggable"
      via: "useDraggable hook for project drag source"
      pattern: "useDraggable"
    - from: "src/app/api/projects/[id]/route.ts"
      to: "prisma.project.update folderId"
      via: "PATCH handler accepting folderId"
      pattern: "folderId"
---

<objective>
Introduce folder organization for projects: a new Folder data model, CRUD API endpoints for folders, and a completely restructured projects list page with collapsible folders, drag-and-drop to move projects between folders, and context menu for folder management.

Purpose: Users can organize their projects into folders (1 level deep) with intuitive drag-and-drop and right-click interactions, replacing the current flat list and broken subproject concept.
Output: Folder model in Prisma, folder API routes, restructured projects list page with @dnd-kit drag-and-drop and context menu.
</objective>

<execution_context>
@/Users/guidocroon-talentix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guidocroon-talentix/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-projectervaring/01-RESEARCH.md

@prisma/schema.prisma
@src/app/api/projects/route.ts
@src/app/api/projects/[id]/route.ts
@src/app/(dashboard)/projects/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Folder data model, API endpoints, and project API modifications</name>
  <files>
    prisma/schema.prisma
    src/app/api/folders/route.ts
    src/app/api/folders/[id]/route.ts
    src/app/api/projects/route.ts
    src/app/api/projects/[id]/route.ts
  </files>
  <action>
**1. Install @dnd-kit dependencies:**
```bash
npm install @dnd-kit/core @dnd-kit/utilities
```

**2. Update Prisma schema (`prisma/schema.prisma`):**

Add a new `Folder` model:
```prisma
model Folder {
  id        String    @id @default(cuid())
  name      String
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects  Project[]
}
```

On the `Project` model:
- REMOVE `parentId String?` field
- REMOVE the `parent` and `children` relations (the `@relation("ProjectHierarchy")` lines)
- ADD `folderId String?` field
- ADD `folder Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)` relation

On the `User` model:
- ADD `folders Folder[]` relation

Run `npm run db:generate && npm run db:push` to apply changes.

**3. Create folder API routes:**

Create `src/app/api/folders/route.ts` with:
- `GET /api/folders` -- List current user's folders with project counts. Use `getAuthUser()` from `@/lib/auth`. Query `prisma.folder.findMany({ where: { userId: user.id }, orderBy: { name: 'asc' }, include: { _count: { select: { projects: true } } } })`.
- `POST /api/folders` -- Create a folder. Accept `{ name }` in body. Validate name is non-empty string. Create with `prisma.folder.create({ data: { name: name.trim(), userId: user.id } })`. Return 201.

Create `src/app/api/folders/[id]/route.ts` with:
- `PATCH /api/folders/[id]` -- Rename a folder. Accept `{ name }` in body. Verify folder exists and belongs to current user (`folder.userId !== user.id` -> 404). Update with `prisma.folder.update()`.
- `DELETE /api/folders/[id]` -- Delete a folder. Verify ownership. The `onDelete: SetNull` in schema handles moving projects to root automatically. Delete with `prisma.folder.delete()`.

Use the same auth/error patterns as existing API routes: `getAuthUser()`, try/catch, Dutch error messages, consistent HTTP status codes.

**4. Modify projects API (`src/app/api/projects/route.ts`):**

Rewrite the GET handler to return folders + projects in a structured format:
- Fetch folders and root projects in parallel using `Promise.all()`
- Folders query: `prisma.folder.findMany({ where: { userId: user.id }, orderBy: { name: 'asc' }, include: { projects: { where: roleFilter, orderBy: { updatedAt: 'desc' }, select: { id, name, status, updatedAt } }, _count: { select: { projects: true } } } })`
- Root projects query: `prisma.project.findMany({ where: { ...roleFilter, folderId: null }, orderBy: { updatedAt: 'desc' }, select: { id, name, status, updatedAt } })`
- For admin users: no role filter. For non-admin: filter by `users: { some: { userId: user.id } }`.
- Return `{ folders, projects }` (NOT a flat array).
- REMOVE all `parentId` logic from the GET handler.
- In the POST handler: REMOVE `parentId` from body destructuring and `data` object. Instead, accept optional `folderId` and validate the folder exists if provided.

**5. Extend project PATCH handler (`src/app/api/projects/[id]/route.ts`):**

Add `folderId` handling in the PATCH handler:
- Accept `folderId` in body (can be `null` to move to root, or a folder ID string).
- Add `folderId` to the `updateData` type.
- If `body.folderId !== undefined`: if `null`, set `updateData.folderId = null`. If string, verify folder exists with `prisma.folder.findUnique()`, return 404 if not found, then set `updateData.folderId = body.folderId`.

All error messages in Dutch. Follow existing code patterns exactly.
  </action>
  <verify>
Run `npm run db:generate` and `npm run db:push` successfully. Run `npm run build` to verify no TypeScript errors. Verify the API routes compile by checking the build output for the new route files.
  </verify>
  <done>
Folder model exists in Prisma schema with onDelete:SetNull. parentId and ProjectHierarchy relation removed from Project model. GET /api/folders returns user's folders with project counts. POST /api/folders creates folder. PATCH/DELETE /api/folders/[id] rename and delete folders. GET /api/projects returns { folders, projects } structure. PATCH /api/projects/[id] accepts folderId for moving projects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Projects list page with folders, drag-and-drop, and context menu</name>
  <files>
    src/app/(dashboard)/projects/page.tsx
    src/components/FolderItem.tsx
    src/components/ProjectCard.tsx
    src/hooks/useContextMenu.ts
    src/components/ContextMenu.tsx
  </files>
  <action>
**1. Create `src/hooks/useContextMenu.ts`:**

A reusable hook for right-click context menus:
- State: `contextMenu: { x: number; y: number } | null`
- `handleContextMenu(e: React.MouseEvent)` -- `e.preventDefault()`, set position from `e.clientX`/`e.clientY`. Apply boundary checks: if `x + 160 > window.innerWidth` then adjust x. If `y + 100 > window.innerHeight` then adjust y.
- `close()` -- set contextMenu to null.
- `useEffect` that adds `document.addEventListener('click', close)` when contextMenu is non-null, with cleanup.
- Export `{ contextMenu, handleContextMenu, close }`.

**2. Create `src/components/ContextMenu.tsx`:**

A generic positioned context menu component:
- Props: `{ x: number; y: number; items: Array<{ label: string; onClick: () => void; danger?: boolean }> }`
- Render a fixed-position `div` at `(x, y)` with `z-50`, white background, rounded shadow, items as buttons.
- Danger items get `text-red-600` styling.
- Use `'use client'` directive.

**3. Create `src/components/ProjectCard.tsx`:**

A draggable project card component:
- Props: `{ project: { id: string; name: string; status: string; updatedAt: string } }`
- Use `useDraggable({ id: project.id })` from `@dnd-kit/core`.
- Apply `CSS.Transform.toString(transform)` from `@dnd-kit/utilities` for drag visual.
- Render as a `div` wrapping a `Link` to `/projects/${project.id}`.
- Show: project name, status badge (Actief/Voltooid/Gearchiveerd), formatted date (nl-NL).
- Add a drag handle icon (GripVertical from lucide-react) on the left side.
- When `isDragging` is true, apply reduced opacity (`opacity-50`).
- Per locked decision: simplified display -- name, status badge, date. NO counts.
- IMPORTANT: Set `tabIndex={-1}` on the draggable `div` and keep the `Link` as a child so clicks navigate but drags work. Use the `listeners` and `attributes` from useDraggable ONLY on the drag handle, not the whole card. This prevents click-vs-drag conflicts.

**4. Create `src/components/FolderItem.tsx`:**

A collapsible folder with droppable zone:
- Props: `{ folder: { id: string; name: string; _count: { projects: number } }; children: React.ReactNode; onRename: (id: string, name: string) => void; onDelete: (id: string) => void }`
- Use `useDroppable({ id: 'folder-' + folder.id })` from `@dnd-kit/core`.
- State: `isOpen` (boolean, default true).
- Click on folder header toggles `isOpen`.
- Use `useContextMenu()` hook on the folder header for right-click.
- When `isOver` (from useDroppable), apply `bg-sky-50 rounded-lg` highlight.
- Render:
  - Header row: ChevronDown/ChevronRight icon, FolderOpen/Folder icon (amber-500), folder name, project count on the right.
  - When open: children (ProjectCard items) indented with `ml-6`.
  - Context menu (when active): "Hernoemen" and "Verwijderen" (danger) options.
- For rename: show an inline input field (replace the folder name text) when rename is selected. On Enter or blur, call `onRename(folder.id, newName)`. On Escape, cancel.
- Use `'use client'` directive.

**5. Rewrite `src/app/(dashboard)/projects/page.tsx`:**

Complete rewrite of the projects list page:

State:
- `folders` and `projects` (root projects) from API response.
- `loading`, `error` states.
- `newFolderName` for creating folders.
- `showNewFolderInput` boolean.

Data fetching:
- `useEffect` on mount: `fetch('/api/projects')` which now returns `{ folders, projects }`. Destructure and set state.

Drag-and-drop setup:
- Import `DndContext`, `DragEndEvent`, `DragOverlay`, `PointerSensor`, `useSensor`, `useSensors` from `@dnd-kit/core`.
- Configure `PointerSensor` with `activationConstraint: { distance: 8 }` to prevent click conflicts.
- `handleDragEnd(event: DragEndEvent)`:
  - Extract `active.id` (project ID) and `over?.id` (droppable target).
  - If `!over`, return (no valid target).
  - If `over.id === 'root'`, PATCH project with `folderId: null`.
  - If `over.id` starts with `'folder-'`, extract folder ID, PATCH project with `folderId`.
  - After PATCH succeeds, optimistically update local state: remove project from source, add to destination.
  - If PATCH fails, revert state and log error.

Root droppable:
- CRITICAL: Create a root-level `useDroppable({ id: 'root' })` that wraps the entire projects area. This allows projects to be dragged OUT of folders back to root. Without this, projects get stuck in folders.

Layout:
- Header: "Projecten" title, "+ Nieuwe map" button, "+ Nieuw project" Link.
- "+ Nieuwe map" shows inline input field. On Enter: `POST /api/folders` with name, add to local state, hide input. On Escape: hide input.
- Wrap everything in `<DndContext sensors={sensors} onDragEnd={handleDragEnd}>`.
- Root droppable div wrapping:
  - Folders section (mapped FolderItem components with ProjectCard children).
  - Root projects section (ProjectCard components for projects with `folderId: null`).
- Empty state: "Nog geen projecten" with link to create.

Folder action handlers:
- `handleRenameFolder(id, name)`: `PATCH /api/folders/${id}` with `{ name }`. Update local state.
- `handleDeleteFolder(id)`: `confirm()` dialog ("Weet je zeker...? Projecten worden losse projecten."). `DELETE /api/folders/${id}`. Move folder's projects to root projects in local state. Remove folder from local state.

Use `'use client'` directive. All text in Dutch.
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Run `npm run dev` and navigate to `/projects` to verify:
1. Folders appear above root projects.
2. "+ Nieuwe map" creates a folder.
3. Right-click on folder shows context menu with "Hernoemen" and "Verwijderen".
4. Dragging a project into a folder moves it.
5. Dragging a project out of a folder to root area moves it back.
6. Clicking a project navigates to its detail page (drag does not interfere).
  </verify>
  <done>
Projects list page shows collapsible folders above root projects. Users can create folders, rename/delete them via context menu. Projects can be dragged into and out of folders. Project cards show name, status badge, and date (simplified). Navigation clicks work without triggering drag.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors.
2. Prisma schema has Folder model and Project.folderId (no parentId).
3. `/projects` page loads and shows folders + projects structure.
4. Creating, renaming, and deleting folders works via UI.
5. Drag-and-drop moves projects between folders and root.
6. Context menu appears on right-click and dismisses on click-outside.
7. Folder deletion moves contained projects to root (not deleted).
</verification>

<success_criteria>
- Folder CRUD operations work end-to-end (create, rename, delete via API and UI).
- Projects can be moved into and out of folders via drag-and-drop.
- Projects list shows folders (collapsible) above root projects.
- Project cards display name, status badge, and date only.
- No TypeScript build errors.
</success_criteria>

<output>
After completion, create `.planning/phases/01-projectervaring/01-01-SUMMARY.md`
</output>
